"use strict";angular.module("sgisServices",["uiGmapgoogle-maps","ngResource"]),angular.module("sgisApp",["ngResource","ngTouch","map-module","sgisServices","ngTagsInput","ngDialog"]).config(["$resourceProvider",function(a){a.defaults.stripTrailingSlashes=!1}]),angular.module("sgisApp").controller("DatasetListController",["$scope","getServices","sharedTagService",function(a,b,c){a.datasets=b.datasetList.query(function(){var c=a.datasets;a.datasets=a.datasets.results;for(var d=function(e){c=b.datasetList.query({page:e},function(){for(var b=0;b<c.results.length;b++)c.results[b].active=!1;a.datasets=a.datasets.concat(c.results),null!==c.next&&d(e+1)})},e=0;e<a.datasets.length;e++)a.datasets[e].active=!1;null!==c.next&&d(2)}),a.activeTags=c.getTagList(),a.getDataset=function(b){return a.datasets[b]}}]),angular.module("sgisApp").controller("FilterController",["$scope","sharedTagService",function(a,b){a.tags=[],a.matchAll=!1,a.getActiveTags=b.getTagListForInput,a.matchChange=function(){b.setMatchAll(a.matchAll)},a.runFilter=function(){var c=[];for(var d in a.tags)c.push(a.tags[d].text);b.setFilterByList(c)},a.clearTags=function(){a.tags=[],a.runFilter()}}]),angular.module("map-module",["uiGmapgoogle-maps","sgisServices","ngAutocomplete"]).controller("MapController",["$scope","$window","config","envService","sharedTagService","getServices","uiGmapGoogleMapApi","ngDialog",function(a,b,c,d,e,f,g,h){d.init(),$("#map .angular-google-map-container").height(b.innerHeight-90);var i={};a.stop=!0,a.colors={},a.dataLayers={},a.userCircles=[],a.map={center:{latitude:42.68,longitude:-73.75},zoom:12,control:{}},a.findLocation={search:"",details:{},options:{}},a.radius=1,a.unit="mi",a.allUnits=["mi","km"];var j=function(a){var b=c.svg;return b.fillColor=a,b},k=function(b){if(!a.colors.hasOwnProperty(b)){var c=function(a){var c=b*a%256;return c=c.toString(16),2===c.length?c:"0"+c},d=c(25),e=c(30),f=c(100);a.colors[b]={color:"#"+d+e+f}}return a.colors[b].color},l=function(a){var b=a.getProperty("dataset"),c=k(b);return{icon:j(c),fillColor:c,fillOpacity:.3,strokeColor:c,strokeWeight:1,clickable:!0}},m=function(){var b=a.map.control.getGMap().getBounds();d.setBoundingBox({max_lat:b.getNorthEast().lat(),max_lon:b.getNorthEast().lng(),min_lat:b.getSouthWest().lat(),min_lon:b.getSouthWest().lng()})},n=function(b){a.dataLayers[b]=new google.maps.Data,a.dataLayers[b].setStyle(l)};a.map.events={tilesloaded:function(b){m(),a.mapInstance=b,a.stopStart()},bounds_changed:function(){m();for(var b in d.getActiveDatasets())a.loadDataset(b)}},a.recenterMap=function(){if(""!==a.findLocation.search){for(var b=100;b&&!a.findLocation.details.geometry.location;)b-=1;a.map.control.getGMap().setCenter(a.findLocation.details.geometry.location)}},a.changeUnit=function(b){a.unit=b},a.addCircles=function(){if(""!==a.findLocation.search){var b;switch(a.unit){case"mi":b=1609.34*a.radius;break;case"km":b=1e3*a.radius}a.userCircles.push(new google.maps.Circle({strokeColor:"#000000",strokeOpacity:1,strokeWeight:1,fillOpacity:0,map:a.map.control.getGMap(),center:a.findLocation.details.geometry.location,radius:b,draggable:!0}))}},a.clearCircles=function(){for(;a.userCircles.length;){var b=a.userCircles.pop();b.setMap(null),b=null}},a.loadDataset=function(b){if(!a.stop){var c=d.getBoundingBox();c.dataset=b,c.tag=e.getFilterTagList(),c.tag.length>0?c.match=e.getMatch():(delete c.tag,delete c.match),i.hasOwnProperty(b)||(i[b]={}),i[b].hasOwnProperty(c)||(i[b][c]=1),c.page=i[b][c];var g=function(d){c.page=d;var e=f.mapElement.query(c,function(){a.dataLayers[b].addGeoJson(e.results),e.next&&!a.stop?g(c.page+1):a.stop&&(i[b][c]=c.page+1,delete c.page)})};g(1),a.dataLayers[b].addListener("click",function(a){h.open({template:"views/info.html",controller:"InfoWindowController",data:a})})}},a.refreshMap=function(){a.stop=!0,a.dataLayers={},a.stop=!1;for(var b in d.getActiveDatasets())a.dataLayers.hasOwnProperty(b)||n(b),a.loadDataset(b)},a.applyFilter=function(){var b=e.getFilterByList();for(var c in a.dataLayers)a.dataLayers[c].forEach(function(d){if(0===b.length)a.dataLayers[c].overrideStyle(d,{visible:!0});else if("all"===e.getMatch())for(var f in b)-1===$.inArray(b[f],d.getProperty("tags"))?a.dataLayers[c].overrideStyle(d,{visible:!1}):a.dataLayers[c].overrideStyle(d,{visible:!0});else{a.dataLayers[c].overrideStyle(d,{visible:!1});for(var g in b)$.inArray(b[g],d.getProperty("tags"))>-1&&a.dataLayers[c].overrideStyle(d,{visible:!0})}})},a.stopStart=function(){if(a.stop=!a.stop,!a.stop)for(var b in d.getActiveDatasets())a.loadDataset(b)},a.toggleActivatedDataset=function(b){b.active?(a.stop=!1,e.addTags(b),d.addActiveDataset(b.id),a.dataLayers.hasOwnProperty(b.id)||n(b.id),a.dataLayers[b.id].setMap(a.mapInstance),a.loadDataset(b.id)):(a.stop=!0,e.removeTags(b),d.removeActiveDataset(b.id),a.dataLayers[b.id].setMap(null),a.stopStart())}}]),angular.module("sgisServices").service("config",function(){var a=function(){var b={map:{maxZoomLevelLoading:8,starting:{zoom:12,center:{latitude:42.68,longitude:-73.7}}},svg:{path:"M 9.81,29.50 C 9.45,29.44 9.22,29.41 9.22,29.14 9.17,28.95 9.17,28.95 8.77,27.36 8.77,27.36 8.14,25.24 7.27,23.18 6.16,21.26 6.16,21.26 4.66,18.82 4.66,18.82 3.64,17.28 2.58,15.76 1.67,14.15 1.06,13.07 0.59,12.30 0.28,11.07 0.04,10.12 0.05,9.60 0.05,8.64 0.05,7.80 0.36,6.48 0.70,5.71 1.05,4.91 1.45,4.21 2.01,3.53 2.73,2.65 3.57,1.93 4.55,1.34 5.48,0.79 6.74,0.35 7.81,0.17 7.81,0.17 8.63,0.06 8.63,0.06 8.63,0.06 9.86,0.06 9.86,0.06 10.49,0.05 11.23,0.18 11.85,0.33 15.10,1.12 17.69,3.45 18.61,6.61 18.76,7.12 18.94,8.02 18.95,8.54 18.96,9.66 18.94,10.33 18.62,11.42 18.34,12.37 17.84,13.23 17.38,14.10 16.63,15.51 15.72,16.81 14.83,18.13 14.09,19.22 13.37,20.35 12.73,21.50 11.71,23.34 10.73,25.53 10.21,27.56 10.21,27.56 9.86,29.00 9.86,29.00 9.80,29.26 9.81,29.50 Z",anchor:{x:9.81,y:29.5},fillOpacity:1,scale:1.2,strokeColor:"black",strokeWeight:3},serverRoot:"http://127.0.0.1:8000",routes:{datasetList:"/api-ds/",mapElement:"/api-test/",mapPoint:"/api-mp/",mapPolygon:"/api-poly/",tag:"/api-tag/"},route:function(a){var b=this.routes[a];return void 0!==this.serverRoot?this.serverRoot+b:"http://127.0.0.1:8000"+b},makeConfig:a};if(void 0!==window.config){var c=function(a,b){var d=b;for(var e in a)d[e]="object"==typeof a[e]?c(a[e],b[e]):a[e];return d};b=c(window.config,b)}return b};return a()}),angular.module("sgisServices").service("envService",[function(){var a,b,c,d;return{init:function(){a={},b={},c={},d=!1},getBoundingBox:function(){return a},getActiveDatasets:function(){return b},setBoundingBox:function(b){a=b},setActiveDatasets:function(a){b=a},addActiveDataset:function(a){b[a]=!0},removeActiveDataset:function(a){delete b[a]}}}]),angular.module("sgisServices").service("getServices",["$resource","config",function(a,b){return{datasetList:a(b.route("datasetList"),{},{query:{method:"GET",isArray:!1}}),mapElement:a(b.route("mapElement"),{},{query:{method:"GET",isArray:!1,params:{page_size:100},transformResponse:function(a){return JSON.parse(a)}}}),mapElementData:a(b.route("mapElement")+":id/",{},{query:{method:"GET",isArray:!1,params:{page_size:100},transformResponse:function(a){return JSON.parse(a).properties.data}}}),tag:a(b.route("tag"),{},{save:{method:"POST"}})}}]),angular.module("sgisServices").service("sharedTagService",function(){var a={},b=[],c=!0;return{getTagList:function(){return Object.keys(a)},getFilterTagList:function(){return Object.keys(b)},getTagListForInput:function(){var b=[];for(var c in a)b.push({text:c});return b},addTags:function(b){for(var c=0;c<b.tags.length;c++)a.hasOwnProperty(b.tags[c])?a[b.tags[c]][b.id]=!0:(a[b.tags[c]]={},a[b.tags[c]][b.id]=!0)},removeTags:function(b){for(var c=0;c<b.tags.length;c++)a.hasOwnProperty(b.tags[c])&&a[b.tags[c]].hasOwnProperty(b.id)&&delete a[b.tags[c]][b.id]},getFilterByListForInput:function(){var a=[];for(var c in b)a.push({text:c});return a},getFilterByList:function(){return b},addToFilterByList:function(a){b=b.concat(a)},setFilterByList:function(a){b=a},matchAll:function(){c=!0},matchAny:function(){c=!1},getMatch:function(){return c?"all":"any"},setMatchAll:function(a){c=a},checkTagApproved:function(b,c){return a.hasOwnProperty(b)&&a[b].hasOwnProperty(c)?!0:!1}}}),angular.module("sgisApp").controller("InfoWindowController",["$scope","sharedTagService","getServices",function(a,b,c){if(a.clickedPoint={},a.clickedPoint.name=a.ngDialogData.feature.getProperty("name"),a.clickedPoint.address=a.ngDialogData.feature.getProperty("address"),null!==a.clickedPoint.address.street)a.clickedPoint.address=[a.clickedPoint.address.street,a.clickedPoint.address.city+", "+a.clickedPoint.address.state+" "+a.clickedPoint.address.zipcode,a.clickedPoint.address.county+" County"];else{var d=a.clickedPoint.address;a.clickedPoint.address=[];for(var e in d)a.clickedPoint.address.push(d[e])}a.availableTags=b.getTagListForInput(),a.tags=[];var f=a.ngDialogData.feature.getProperty("tags");for(var g in f)a.tags.push({text:f[g]});a.dataList=c.mapElementData.query({data:"all",id:a.ngDialogData.feature.getId()},function(){}),a.approved=!0;var h=function(a){for(var b in f)if(a===f[b])return!1;return!0};a.pushTags=function(){for(var d in a.tags)h(a.tags[d].text)&&c.tag.save({mapelement:a.ngDialogData.feature.getId(),tag:a.tags[d].text},function(){f.push(a.tags[d].text),b.checkTagApproved(a.tags[d].text,a.ngDialogData.feature.getProperty("dataset"))||(a.approved=!1)})}}]);